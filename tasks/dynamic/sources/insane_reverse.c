#include <sys/ptrace.h>
#include <sys/mman.h>
#include <unistd.h>
#include <stdlib.h>
#include <string.h>
#include <stdio.h>
#include <time.h>

// FLAG = RR_INS{Wo00o0w_lo0ks_l1ke_your3_pr0_r3v3rser!}

extern unsigned char* _start;
extern unsigned char* __etext;

int main(void) 
{
    int size = 0;
    int key = 0;
    void (*decrypt_code)(int*, char*, int*, int*); // decrypt_code(int* encrypted_code, char* decrypted_code, int* size, int* key)
    char decryptor_code[] = "\x55\x48\x89\xe5\x48\x89\x7d\xe8\x48\x89\x75\xe0\x48\x89\x55\xd8\x48\x89\x4d\xd0\xc7\x45\xfc\x00\x00\x00\x00\xeb\x45\x8b\x45\xfc\x48\x63\xd0\x48\x8b\x45\xe0\x48\x01\xc2\x8b\x45\xfc\x48\x98\x48\x8d\x0c\x85\x00\x00\x00\x00\x48\x8b\x45\xe8\x48\x01\xc8\x8b\x00\x83\xc0\x22\x83\xf0\x23\x83\xe8\x68\x83\xf0\x93\x83\xc0\x23\x89\xc1\x48\x8b\x45\xd0\x8b\x00\x31\xc8\x83\xe8\x0c\x88\x02\x83\x45\xfc\x01\x48\x8b\x45\xd8\x8b\x00\x3b\x45\xfc\x7f\xb0\x90\x5d\xc3";
    change_perm(decryptor_code);
    decrypt_code = decryptor_code;

    int enc_detect_bp_code[] = {0x3266, 0x3299, 0x31da, 0x32f6, 0x3299, 0x31da, 0x31ce, 0x32e9, 0x3299, 0x31da, 0x31c6, 0x32e1, 0x32b4, 0x3296, 0x3025, 0x3351, 0x3351, 0x3351, 0x3351, 0x3299, 0x31d8, 0x3296, 0x32e9, 0x3299, 0x3356, 0x329b, 0x3352, 0x3351, 0x3351, 0x3299, 0x31da, 0x3296, 0x3049, 0x3299, 0x31d8, 0x3296, 0x32e1, 0x3299, 0x31da, 0x3296, 0x32f9, 0x32f8, 0x3227, 0x3299, 0x31d8, 0x3296, 0x3049, 0x31d8, 0x3351, 0x335c, 0x32e3, 0x3311, 0x328e, 0x331d, 0x3351, 0x3351, 0x3351, 0x31c6, 0x3356, 0x32fa, 0x3351, 0x3351, 0x3351, 0x3351, 0x3299, 0x31d0, 0x3296, 0x3049, 0x3352, 0x3299, 0x31d8, 0x3296, 0x3049, 0x3299, 0x3288, 0x3296, 0x32f9, 0x31c6, 0x32ed, 0x31a1, 0x326e, 0x3310};                        // key = 0x1292

    int enc_print_str_code[] = {0x62f9, 0x6306, 0x6325, 0x6269, 0x6306, 0x6325, 0x6321, 0x62d6, 0x6306, 0x6325, 0x6359, 0x626e, 0x6306, 0x6287, 0x6287, 0x61dd, 0x619e, 0x619e, 0x619e, 0x6306, 0x6323, 0x62f9, 0x626e, 0x6306, 0x6323, 0x6359, 0x62d6, 0x6306, 0x62ad, 0x625e, 0x6306, 0x629f, 0x625e, 0x61cf, 0x61c9, 0x634e, 0x6341, 0x629b}; // key = 0x4207

    int enc_checker[]        = {0x39b4, 0x39e7, 0x3928, 0x3964, 0x39e7, 0x3928, 0x393c, 0x3987, 0x39e7, 0x3928, 0x3a54, 0x395f, 0x39e7, 0x3928, 0x39b4, 0x3997, 0x3966, 0x3a44, 0x2cbb, 0x39ff, 0x39ff, 0x39ff, 0x39ff, 0x3966, 0x3a44, 0x2cb7, 0x39ff, 0x39ff, 0x39ff, 0x39ff, 0x398a, 0x3a54, 0x392a, 0x3a44, 0x2cbb, 0x39e7, 0x3a57, 0x39e7, 0x392c, 0x2c73, 0x3984, 0x39ff, 0x39ff, 0x39ff, 0x39ff, 0x39e7, 0x392a, 0x3a44, 0x3987, 0x39e7, 0x3a00, 0x396f, 0x392a, 0x39af, 0x392a, 0x3a44, 0x2cb7, 0x39e7, 0x3a57, 0x39e7, 0x392c, 0x39ab, 0x3984, 0x39ff, 0x39ff, 0x39ff, 0x39ff, 0x39e7, 0x392a, 0x3a44, 0x395f, 0x39e7, 0x3a00, 0x3967, 0x392a, 0x39ff, 0x39f8, 0x39c1, 0x3a54, 0x39fd, 0x392a, 0x3a44, 0x2cbb, 0x39e7, 0x3a57, 0x39e7, 0x3982, 0x39bf, 0x3a00, 0x39e7, 0x392c, 0x2c73, 0x3984, 0x39ff, 0x39ff, 0x39ff, 0x39ff, 0x39e7, 0x392a, 0x3a44, 0x3987, 0x39e7, 0x3a00, 0x396f, 0x392a, 0x39af, 0x392a, 0x3a44, 0x2cb7, 0x39e7, 0x3a57, 0x39e7, 0x392c, 0x39ab, 0x3984, 0x39ff, 0x39ff, 0x39ff, 0x39ff, 0x39e7, 0x392a, 0x3a44, 0x3997, 0x39e7, 0x3a00, 0x3967, 0x392a, 0x39ff, 0x39f8, 0x39c1, 0x3a54, 0x39a9, 0x3982, 0x3a44, 0x2cb7, 0x3a00, 0x3982, 0x3a44, 0x2cbb, 0x3a01, 0x398a, 0x39a6, 0x3977, 0x39ff, 0x39ff, 0x39ff, 0x39ff, 0x398a, 0x3a05, 0x3982, 0x393c, 0x2cb7, 0x2ccc, 0x393d, 0x3984, 0x3a1c, 0x39c2};                                         // key = 0x1920
    
    int enc_encryptor[]      = {0x52a3, 0x4fb8, 0x4f77, 0x4ff3, 0x4fb8, 0x4f77, 0x4f6b, 0x5048, 0x4fb8, 0x4f77, 0x4fc3, 0x4f80, 0x4fb8, 0x4f77, 0x52a3, 0x4f38, 0x5055, 0x52d3, 0x505c, 0x4ff0, 0x4ff0, 0x4ff0, 0x4ff0, 0x5055, 0x52d3, 0x52ec, 0x4fb8, 0x5011, 0x4ff0, 0x4ff0, 0x5055, 0x52d3, 0x52e8, 0x4ff0, 0x4ff0, 0x4ff0, 0x4ff0, 0x5055, 0x52d3, 0x5344, 0x4ff0, 0x4ff0, 0x4ff0, 0x4ff0, 0x5057, 0x4f8c, 0x4ff0, 0x4ff0, 0x4ff0, 0x4f79, 0x52d3, 0x5344, 0x4fb8, 0x52d1, 0x4f80, 0x4fb8, 0x4f79, 0x52d3, 0x5048, 0x4fb8, 0x4fef, 0x4f80, 0x4ffd, 0x4f26, 0x4ff0, 0x4ffd, 0x4f2e, 0x4f30, 0x5003, 0x5017, 0x5042, 0x4ff0, 0x4ff0, 0x4f77, 0x52d3, 0x505c, 0x4fb8, 0x4f79, 0x52d3, 0x4f38, 0x4f79, 0x5040, 0x4f79, 0x52d3, 0x5344, 0x4f71, 0x4f30, 0x4fef, 0x4ffd, 0x4f9d, 0x52d3, 0x52ec, 0x4fef, 0x4f32, 0x4fb8, 0x4f79, 0x52d3, 0x4f38, 0x4f77, 0x5040, 0x4f79, 0x52d3, 0x52e8, 0x4fb8, 0x4f88, 0x4fb8, 0x4f7b, 0x4fe4, 0x4f93, 0x4ff0, 0x4ff0, 0x4ff0, 0x4ff0, 0x4fb8, 0x4f79, 0x52d3, 0x4f80, 0x4fb8, 0x4fef, 0x4f32, 0x4fb8, 0x4f79, 0x52d3, 0x4f38, 0x4f79, 0x4ff0, 0x4f77, 0x4ff2, 0x4f79, 0x52d3, 0x52e8, 0x4fb8, 0x4f88, 0x4fb8, 0x4f71, 0x4f30, 0x4fef, 0x4fb8, 0x4f7b, 0x4fe4, 0x4f93, 0x4ff0, 0x4ff0, 0x4ff0, 0x4ff0, 0x4fb8, 0x4f79, 0x52d3, 0x4f80, 0x4fb8, 0x4fef, 0x4f80, 0x4f79, 0x52a3, 0x52e8, 0x4fb8, 0x52d1, 0x4f82, 0x4fb8, 0x4f7b, 0x4ffc, 0x4f63, 0x4ff0, 0x4ff0, 0x4ff0, 0x4ff0, 0x4fb8, 0x4f79, 0x52a3, 0x4f80, 0x4fb8, 0x4fef, 0x4f3a, 0x4f79, 0x5042, 0x4f79, 0x4fbb, 0x505c, 0x5017, 0x4f7f, 0x4f77, 0x4f3a, 0x4f71, 0x505a, 0x4ff1, 0x4f70, 0x5022, 0x4f77, 0x4f77, 0x5040, 0x4f71, 0x52d3, 0x5344, 0x4fef, 0x4f6f, 0x52d3, 0x52ec, 0x4ffa, 0x5013, 0x4ff0, 0x4ff0, 0x4f71, 0x52d3, 0x52e8, 0x4ff2, 0x4f71, 0x4f6b, 0x5344, 0x501b, 0x4ffd, 0x4fbe, 0x52ca, 0x52ed, 0x52ed, 0x52ed, 0x5055, 0x52d3, 0x5020, 0x4ff0, 0x4ff0, 0x4ff0, 0x4ff0, 0x5057, 0x4f7c, 0x4ff0, 0x4ff0, 0x4ff0, 0x4f79, 0x52d3, 0x5020, 0x4f71, 0x5050, 0x4fef, 0x4f93, 0x4f30, 0x4fc3, 0x4f6b, 0x4f79, 0x52d3, 0x5020, 0x4fb8, 0x4f88, 0x4fb8, 0x4f7b, 0x4fe4, 0x4f93, 0x4ff0, 0x4ff0, 0x4ff0, 0x4ff0, 0x4fb8, 0x4f79, 0x52d3, 0x4f80, 0x4fb8, 0x4fef, 0x4f80, 0x4f79, 0x4ff0, 0x4f77, 0x52d3, 0x505c, 0x4f79, 0x52d3, 0x5020, 0x4fb8, 0x4f88, 0x4fb8, 0x4f7b, 0x4fe4, 0x4f93, 0x4ff0, 0x4ff0, 0x4ff0, 0x4ff0, 0x4fb8, 0x4f79, 0x52d3, 0x4f80, 0x4fb8, 0x4fef, 0x4f32, 0x4f79, 0x52d3, 0x5020, 0x4fb8, 0x52d1, 0x4f38, 0x4f28, 0x4ff0, 0x4ff0, 0x4ff0, 0x4ff0, 0x4fb8, 0x5017, 0x4f38, 0x4fb8, 0x4f2f, 0x5050, 0x4ff2, 0x4fb8, 0x4f7b, 0x4f78, 0x52dc, 0x4fef, 0x4ff0, 0x4ff0, 0x4fb8, 0x4f79, 0x52d3, 0x4f80, 0x4fb8, 0x4fef, 0x4f38, 0x4f79, 0x4ff0, 0x5003, 0x4f3b, 0x5014, 0x4ff0, 0x4ff0, 0x4f77, 0x4ff2, 0x4f79, 0x52d3, 0x5020, 0x4fb8, 0x52d1, 0x4f80, 0x4f28, 0x4ff0, 0x4ff0, 0x4ff0, 0x4ff0, 0x4fb8, 0x5017, 0x4f80, 0x4fb8, 0x4f2f, 0x5050, 0x4ff2, 0x4fb8, 0x4f7b, 0x4fc0, 0x52dc, 0x4fef, 0x4ff0, 0x4ff0, 0x4fb8, 0x4f79, 0x52d3, 0x4f80, 0x4fb8, 0x4fef, 0x4f32, 0x4f79, 0x52d3, 0x505c, 0x4f77, 0x4ff2, 0x5059, 0x4fef, 0x4fc0, 0x4f71, 0x52d3, 0x5020, 0x4fef, 0x4f71, 0x4f6b, 0x5020, 0x501b, 0x4ffd, 0x4fbe, 0x52da, 0x52ed, 0x52ed, 0x52ed, 0x4fc0, 0x52cb, 0x4f31}; // key = 0x3371


    int chars[] = {3455, 3518, 3381, 3480, 3508, 3536, 3540, 3426, 3545, 3352, 3556, 3487, 3436, 3534, 3524, 3331, 3439, 3496, 3369, 3328, 3539, 3435, 3457, 3570, 3370, 3322, 3552, 3569, 3446, 3443, 3572, 3332, 3512, 3499, 3458, 3529, 3452, 3336, 3546, 3351, 3356, 3325, 3326, 3484, 3523, 3437, 3520, 3490, 3511, 3565, 3482, 3551, 3466, 3483, 3355, 3323, 3348, 3554, 3451, 3429, 3428, 3525, 3423, 3357, 3549, 3419, 3350, 3362, 3366, 3564, 3533, 3543, 3571, 3541, 3447, 3358, 3456, 3507, 3333, 3334, 3364, 3462, 3548, 3561, 3535, 3563, 3470, 3318, 3478, 3340, 3497, 3349, 3343, 3522, 3544, 3481, 3417, 3573, 3550, 3353, 3432, 3321, 3495, 3344, 3319, 3448, 3467, 3372, 3559, 3339, 3337, 3416, 3346, 3471, 3414, 3420, 3329, 3521, 3450, 3537, 3510, 3380, 3517, 3489, 3519, 3488, 3430, 3468, 3363, 3324, 3359, 3354, 3530, 3555, 3469, 3460, 3338, 3515, 3542, 3486, 3503, 3441, 3347, 3538, 3560, 3531, 3424, 3360, 3493, 3425, 3415, 3477, 3368, 3528, 3526, 3379, 3498, 3378, 3527, 3445, 3459, 3494, 3547, 3475, 3461, 3444, 3491, 3320, 3492, 3421, 3330, 3335, 3374, 3558, 3566, 3513, 3464, 3505, 3504, 3472, 3506, 3377, 3373, 3431, 3361, 3567, 3422, 3465, 3454, 3473, 3532, 3434, 3485, 3327, 3509, 3553, 3367, 3453, 3365, 3463, 3557, 3438, 3375, 3341, 3418, 3442, 3568, 3440, 3449, 3345, 3479, 3371, 3433, 3376, 3562, 3342, 3476, 3514, 3516, 3502, 3474, 3427};

    if (ptrace(PTRACE_TRACEME, 0, 1, 0) < 0) {
        asm("jmp 0x0");
    }

    void (*DetectBreakpoints)(unsigned char*, unsigned char*); // DETECT BREAKPOINTS
    char detect_bp_code[82] = "";
    size = 82;
    key = 0x1292;
    change_perm(detect_bp_code);
    decrypt_code(enc_detect_bp_code, detect_bp_code, &size, &key);
    DetectBreakpoints = detect_bp_code; // DetectBreakpoints(&_start, &__etext);
    DetectBreakpoints(&_start, &__etext);

    void (*print_str)(char *, long int); // My PRINTF  print_str(char* buffer, int size_of_buffer)
    char print_str_code[38] = "";
    size = 38;
    key = 0x4207;
    change_perm(print_str_code);
    decrypt_code(enc_print_str_code, print_str_code, &size, &key);
    print_str = print_str_code;

    int (*check)(int *, int *, int *); // check(encrypted_flag_usr, encrypted_first, encrypted_second)
    char checker[157] = "";
    size = 157;
    key = 0x1920;
    change_perm(checker);
    decrypt_code(enc_checker, checker, &size, &key);
    check = checker;

    void (*encrypt)(char *, int *, int *); // encrypt(flag, encrypted_flag_usr, &random);
    char encryptor[380] = "";
    size = 380;
    key = 0x3371;
    change_perm(encryptor);
    decrypt_code(enc_encryptor, encryptor, &size, &key);
    encrypt = encryptor;
    DetectBreakpoints(&_start, &__etext);

    memset(decrypt_code, 0, 112);

    char flag[120];    
    for (int i = 0; i < 222; ++i)
    {
        chars[i] = ((chars[i] + 10) ^ 3401) - 32;
    }

    // TODO 1 create normal algorithm to encrypt strings. 
    // TODO 2 print strings dynamically
    
    char hello_msg[] = {chars[67], chars[122], chars[20], chars[93], chars[119], chars[193], chars[154], chars[218], chars[143], chars[119], chars[193], chars[14], chars[143], chars[93], chars[5], chars[5], chars[110], chars[193]};
    char win_msg[] = {chars[121], chars[218], chars[6], chars[42], chars[193], chars[155], chars[48], chars[1], chars[20], chars[5], chars[193], chars[120], chars[20], chars[42], chars[96]};
    char fail_msg[] = {chars[63], chars[218], chars[84], chars[93], chars[193], chars[110], chars[104], chars[96]};

    print_str(hello_msg, 18);
    scanf("%119s", flag);

    int encrypted_flag_usr[120 * 2] = {0};
    int encrypted_first[]  = {-51597032, -48509091, -45550680, -42712513, -39992248, -37393650, -34907763, -32534112, -30267907, -28111051, -26060610, -24107907, -22258932, -20504417, -18842068, -17273229, -15795596, -14400370, -13090870, -11862876, -10713428, -9639957, -8642210, 8645937, 9645737, 10719069, 11868513, 13096649, 14406057, 15799317, 17279009, 18847713, 20508009, 22262477, 24113697, 26064249, 28116713, 30273669, 32537697, 34911377, 37397289, 39998013, 42716129, 45554217, 48514857, 51600629};
    int encrypted_second[] = {-6812, -27215, -62017, -113895, -184617, -277751, -395161, -539633, -713881, -920244, -1161246, -1439869, -1758575, -2119763, -2526416, -2980592, -3484714, -4042020, -4655071, -5325613, -6057372, -6852038, -7712324, 7717089, 6856613, 6061929, 5330457, 4659617, 4046829, 3489513, 2985089, 2530977, 2124597, 1763369, 1444713, 1166049, 924797, 718377, 544209, 399713, 282309, 189417, 118457, 66849, 32013, 11369};

    DetectBreakpoints(&_start, &__etext);
    srand(time(NULL));
    int random = rand() % 1 ^ rand() % 1 + 2337; 

    encrypt(flag, encrypted_flag_usr, &random); // encrypt(usr_input_str(char ptr), ptr to int array(where to store enc data))
    
    memset(encrypt, 0, 380);

    if (check(encrypted_flag_usr, encrypted_first, encrypted_second))
    {
        print_str(win_msg, 15);
    }
    else {
        print_str(fail_msg, 8);
    }

    memset(check, 0, 157);
    memset(print_str, 0, 38);
    memset(DetectBreakpoints, 0, 82);

    return 0;
}

int change_perm(void *addr) {
    int page_size = getpagesize();
    addr -= (unsigned long)addr % page_size;
    mprotect(addr, page_size, PROT_WRITE | PROT_EXEC);
    return 0;
}